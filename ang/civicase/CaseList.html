<div crm-ui-debug="cases"></div>
<div crm-ui-debug="viewingCase"></div>
<div crm-ui-debug="viewingCaseTab"></div>
<h1 crm-page-title>{{ pageTitle }}</h1>
<div id="bootstrap-theme" class="clearfix civicase-main">

  <div class="panel panel-default clearfix" ng-class="{'case-is-focused': caseIsFocused}" civicase-search="filters" expanded="searchIsOpen" on-search="applyAdvSearch(selectedFilters)">
    <div class="civicase-filters-placeholder" ng-click="unfocusCase()">
      <i class="fa fa-angle-double-down" aria-hidden="true"></i>
      {{ ts('Filters') }}
      <i class="fa fa-angle-double-down" aria-hidden="true"></i>
    </div>
  </div>

  <div class="civicase-view-with-search pull-right" ng-class="{'case-is-focused': caseIsFocused, 'cc-zero-w': !viewingCase}" civicase-view="viewingCase" civicase-tab="viewingCaseTab" civicase-focused="caseIsFocused"></div>
  <div class="panel panel-default case-list-panel" ng-class="{'viewing-case': viewingCase, 'case-is-focused': caseIsFocused}">

    <table ng-show="!caseIsFocused" class="case-list-table">
      <thead>
        <tr>
          <th>
            <div class="case-list-checkbox" ng-if="!viewingCase">
              <input type="checkbox" ng-click="selectAll($event)" ng-checked="isSelection('all')" />
            </div>
            <div class="btn-group btn-group-sm" ng-if="!viewingCase">
              <button type="button" class="btn btn-default dropdown-toggle {{ isSelection('any') ? '' : 'disabled' }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                {{ ts('Actions') }}
                <span class="caret"></span>
              </button>
              <ul class="dropdown-menu" civicase-actions></ul>
            </div>
            <div class="btn-group btn-group-sm cc-sort-btn-group" ng-class="{'pull-right': !viewingCase}">
              <button class="btn btn-default" ng-click="changeSortDir()">
                <i class="fa" ng-class="{'fa-arrow-circle-up': sortDir === 'ASC', 'fa-arrow-circle-down': sortDir === 'DESC'}"></i>
              </button>
              <select class="btn btn-default" ng-model="sortField">
                <option value="id">{{ ts('Case ID') }}</option>
                <option value="contact_id.sort_name">{{ ts('Case Client') }}</option>
                <option value="subject">{{ ts('Subject') }}</option>
                <option value="status_id.label">{{ ts('Status') }}</option>
                <option value="case_type_id.title">{{ ts('Type') }}</option>
                <option value="case_manager.sort_name">{{ ts('Case Manager') }}</option>
                <option value="my_role.label_b_a">{{ ts('My Role') }}</option>
                <option value="next_activity_category_milestone">{{ ts('Next Milestone') }}</option>
                <option value="next_activity_category_task">{{ ts('Next Task') }}</option>
                <option value="next_activity_category_communication">{{ ts('Next Communication') }}</option>
              </select>
            </div>
          </th>
          <th ng-show="!viewingCase" civicase-sortheader="subject">{{ ts('Subject') }}</th>
          <th ng-show="!viewingCase" civicase-sortheader="status_id.label">{{ ts('Status') }}</th>
          <th ng-show="!viewingCase" civicase-sortheader="case_type_id.title">{{ ts('Type') }}</th>
          <th ng-show="!viewingCase" civicase-sortheader="case_manager.sort_name">{{ ts('Case Manager') }}</th>
          <th ng-show="!viewingCase" civicase-sortheader="my_role.label_b_a">{{ ts('My Role') }}</th>
          <th ng-show="!viewingCase" civicase-sortheader="next_activity_category_milestone">{{ ts('Next Milestone') }}</th>
          <th ng-show="!viewingCase" civicase-sortheader="next_activity_category_task">{{ ts('Next Task') }}</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="item in cases">
          <td ng-click="viewCase(item.id, $event)" ng-class="{'case-selected-for-view': viewingCase === item.id}">
            <div class="case-list-checkbox" ng-if="!viewingCase">
              <input type="checkbox" ng-model="item.selected" />
            </div>
            <div>
              <h4>
                {{ item.client[0].display_name }}
                <div class="btn-group btn-group-sm" ng-if="item.client.length > 1">
                  <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="{{ ts('Additional clients') }}">
                    +{{ item.client.length - 1 }}
                  </button>
                  <ul class="dropdown-menu" >
                    <li ng-repeat="(index, client) in item.client" ng-if="index">
                      <span>{{ client.display_name }}</span>
                    </li>
                  </ul>
                </div>
                <span class="badge unread-emails" ng-if="item.unread_email_count" title="{{ ts('Unread emails') }}">
                  {{ item.unread_email_count }}
                </span>
              </h4>
              <div ng-if="item.client[0].email">
                <strong>{{ ts('Email:') }}</strong>
                {{ item.client[0].email }}
              </div>
              <div ng-if="item.client[0].phone">
                <strong>{{ ts('Phone:') }}</strong>
                {{ item.client[0].phone }}
              </div>
              <div>
                <strong>{{ ts('Case ID:') }}</strong>
                {{ item.id }}
              </div>
              <div ng-if="item.activity_summary.alert.length" class="case-alerts">
                <i class="crm-i fa-exclamation-triangle"></i>
                {{ item.activity_summary.alert.length }}
              </div>
            </div>
          </td>
          <td ng-show="!viewingCase">{{ item.subject }}</td>
          <td ng-show="!viewingCase">{{ item.status }}</td>
          <td ng-show="!viewingCase">{{ item.case_type }}</td>
          <td ng-show="!viewingCase">{{ item.manager.display_name }}</td>
          <td ng-show="!viewingCase">{{ item.myRole.join(', ') }}</td>
          <td ng-show="!viewingCase">
            <div ng-if="item.activity_summary.milestone.length">
              <div>{{ activityTypes[item.activity_summary.milestone[0].activity_type_id].label }}</div>
              <div>{{ CRM.utils.formatDate(item.activity_summary.milestone[0].activity_date_time) }}</div>
            </div>
          </td>
          <td ng-show="!viewingCase">
            <div ng-if="item.activity_summary.task.length">
              <div>{{ activityTypes[item.activity_summary.task[0].activity_type_id].label }}</div>
              <div>{{ CRM.utils.formatDate(item.activity_summary.task[0].activity_date_time) }}</div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <paging
      class="center-block text-center"
      ng-show="!caseIsFocused"
      page="pageNum"
      page-size="pageSize"
      total="totalCount"
      show-prev-next="true"
      show-first-last="true">
    </paging>
    <div class="civicase-table-expander" ng-if="viewingCase && !caseIsFocused" ng-click="viewCase(null)"><div>&raquo;</div></div>
    <div class="civicase-table-placeholder" ng-if="caseIsFocused" ng-click="unfocusCase()"><div>&raquo;</div></div>
  </div>
</div>
